From 50d3a3de8345ddd20b2b82c06e5b0f27728380d2 Mon Sep 17 00:00:00 2001
From: Andrei Zene <andrei.zene@ni.com>
Date: Wed, 9 Sep 2020 22:07:22 +0300
Subject: [PATCH] Fix issue where update did not work for uncompressed feeds

---
 libopkg/opkg_download_curl.c |  6 ++++++
 tests/Makefile               |  1 +
 tests/opk.py                 | 21 +++++++++++++++----
 tests/regress/issue_____.py  | 40 ++++++++++++++++++++++++++++++++++++
 4 files changed, 64 insertions(+), 4 deletions(-)
 create mode 100755 tests/regress/issue_____.py

diff --git a/libopkg/opkg_download_curl.c b/libopkg/opkg_download_curl.c
index d572070..8d6ca6a 100644
--- a/libopkg/opkg_download_curl.c
+++ b/libopkg/opkg_download_curl.c
@@ -245,6 +245,12 @@ static int opkg_validate_cached_file(const char *src, const char *cache_location
         curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &error_code);
         opkg_msg(ERROR, "Failed to download %s headers: %s.\n", src,
                  curl_easy_strerror(res));
+        free(etag);
+        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, NULL);
+        curl_easy_setopt(curl, CURLOPT_HEADERFUNCTION, NULL);
+        curl_easy_setopt(curl, CURLOPT_WRITEHEADER, NULL);
+        curl_easy_setopt(curl, CURLOPT_HEADER, 0);
+        curl_easy_setopt(curl, CURLOPT_NOBODY, 0);
         return -1;
     }
     curl_easy_getinfo(curl, CURLINFO_CONTENT_LENGTH_DOWNLOAD, &src_size);
diff --git a/tests/Makefile b/tests/Makefile
index 4b05928..b4661eb 100644
--- a/tests/Makefile
+++ b/tests/Makefile
@@ -91,6 +91,7 @@ REGRESSION_TESTS := core/01_install.py \
 		    regress/issue11033b.py \
 		    regress/issue11826.py \
                     regress/issue13574.py \
+		    regress/issue_____.py \
 		    misc/filehash.py \
 		    misc/update_loses_autoinstalled_flag.py \
 		    misc/version_comparisons.py
diff --git a/tests/opk.py b/tests/opk.py
index 2db13eb..7bf37bc 100644
--- a/tests/opk.py
+++ b/tests/opk.py
@@ -161,7 +161,7 @@ def xfail(msg):
 	print("%s: Expected failure: %s" % (__appname, msg))
 	exit(0)
 
-def regress_init():
+def regress_init(add_default_feed=True):
 	"""
 	Initialisation and sanity checking.
 	"""
@@ -181,7 +181,20 @@ def regress_init():
 
 	confdir=os.environ['SYSCONFDIR']+"/opkg";
 	os.makedirs(("{}"+confdir).format(cfg.offline_root))
-	f = open(("{}"+confdir+"/opkg.conf").format(cfg.offline_root), "w")
-	f.write("arch all 1\n")
-	f.write("src test file:{}\n".format(cfg.opkdir))
+	append_line_to_conf_file("arch all 1")
+
+def add_default_feed():
+	append_line_to_conf_file("src test file:{}".format(cfg.opkdir))
+
+def add_feed(name, url, compressed):
+	append_line_to_conf_file("{} {} {}".format("src/gz" if compressed else "src", name, url))
+
+def set_option(name, value):
+	append_line_to_conf_file("option {} {}".format(name, value))
+
+def append_line_to_conf_file(line):
+	confdir=os.environ['SYSCONFDIR']+"/opkg";
+	f = open(("{}"+confdir+"/opkg.conf").format(cfg.offline_root), "a+")
+	f.write("{}\n".format(line))
 	f.close()
+
diff --git a/tests/regress/issue_____.py b/tests/regress/issue_____.py
new file mode 100755
index 0000000..3620e56
--- /dev/null
+++ b/tests/regress/issue_____.py
@@ -0,0 +1,40 @@
+#! /usr/bin/env python3
+# SPDX-License-Identifier: GPL-2.0-only
+#
+# Reporter: andrei.zene@ni.com
+#
+# What steps will reproduce the problem?
+# ======================================
+#
+# 1.- add an unreachable compressed feed URL
+# 2.- add a reachable uncompressed feed URL
+#     (Note: steps 1 and 2 need to be in this exact
+#      order and they should not be file URLs so that
+#      the download goes through the curl backend)
+# 3.- set option volatile_cache true
+# 4.- run opkg update
+# 5.- run opkg info on a package from the reachable feed
+#
+# What is the expected output? What do you see instead?
+# ======================================
+#
+# The output should show information about the package
+# Instead opkg info doesn't return anything as if the
+# opkg update failed. However the opkg update command
+# wrote that it updated the reachable feed.
+#
+
+import os
+import opk, cfg, opkgcl
+
+opk.regress_init()
+
+opk.add_feed("unreachable", "unreachable", True)
+opk.add_feed("reachable", "http://download.ni.com/ni-linux-rt/feeds/2020/ni-main/", False)
+opk.set_option("volatile_cache", True)
+
+opkgcl.update()
+
+info = opkgcl.info("ni-euladepot")
+if "Package" not in info:
+    opk.fail("opkg info 'ni-euladepot' returned: '{}'".format(info))
